name: CI/CD Infra Reusable Workflow - Destroy

on:
  workflow_call:

    inputs:

      bucket-tf-backend-name:
        required: true
        type: string
      key-tf-backend-name:
        required: true
        type: string
      needs-clean-cloud-resources:
        required: false
        type: boolean
        default: false        

    secrets:

      VULTR_API_KEY:
        required: true
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true

jobs:

  terraform-execute:
    name: üí£ Terraform execute destroy infra
    runs-on: ubuntu-latest
    env:
      TF_LOG: TRACE
      TF_VAR_VULTR_API_KEY: ${{ secrets.VULTR_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Destroy
        id: destroy
        run: terraform destroy -auto-approve -var-file="./environments/terraform.tfvars" -lock=false

      - name: Delete S3 bucket state file contents - [${{ inputs.bucket-tf-backend-name }}/${{ inputs.key-tf-backend-name }}]
        run: |
          aws s3 rm s3://${{ inputs.bucket-tf-backend-name }}/ --recursive
        
  clean-cloud-resources:
    name: üßπ Clean up cloud resources
    needs: terraform-execute
    runs-on: ubuntu-latest
    
    if: ${{ inputs.needs-clean-cloud-resources }}

    steps:
      - name: Clean up Load Balancer in Vultr Cloud
        run: |

          load_balancers_json=$(curl --request GET --url 'https://api.vultr.com/v2/load-balancers' \
            --header 'Authorization: Bearer ${{ secrets.VULTR_API_KEY }}')
          
          if [ "$(echo "$load_balancers_json" | jq '.load_balancers | length')" -eq 0 ]; then
            echo "üòâ N√£o foi encontrado load balancers provisionados no ambiente."
            exit 0
          fi
          
          load_balancer_id=$(echo $load_balancers_json | jq -r '.load_balancers[] | select(.label | contains("labs-service-lb")) | .id')

          if [[ -z "$load_balancer_id" ]]; then
            echo "üòâ N√£o foi encontrado load balancer com label 'labs-service-lb'."
            exit 0
          fi

          echo "‚úÖ Load balancer encontrado ${load_balancer_id}"

          echo "üî• Removendo load balancer: ${load_balancer_id}"

          response_code=$(curl --request DELETE -s -o /dev/null -w "%{http_code}" --url "https://api.vultr.com/v2/load-balancers/$load_balancer_id" \
            --header 'Authorization: Bearer ${{ secrets.VULTR_API_KEY }}')

          if [ "$response_code" -eq 204 ]; then
            echo "‚úÖ Load balancer removido com sucesso."
            exit 0
          else
            echo "‚ùå Falha ao remover load balancer."
            echo "$delete_response"
            exit 0
          fi  
          


